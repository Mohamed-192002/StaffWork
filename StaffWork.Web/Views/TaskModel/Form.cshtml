@model TaskModelFormViewModel

@{
	ViewData["Title"] = "المهام";
	int i = 1;
}

<div class="card shadow-sm">
	<div class="card-header">
		<h3 class="card-title"> مهمه</h3>
	</div>
	<div class="card-body">
		<form method="post" asp-controller="TaskModel" enctype="multipart/form-data" id="Form">
			@if (Model.Id > 0)
			{
				<input type="hidden" asp-for="Id" />
			}
			<div class="row col-12">
				<div class="row col-6 mb-6">
					<!--begin::Label-->
					<label class="col-lg-4 col-form-label required fw-semibold fs-6" asp-for="Title"></label>
					<!--end::Label-->
					<div class="col-lg-8">
						<!--begin::Row-->
						<div class="row">
							<!--begin::Col-->
							<div class="col-lg-8 fv-row fv-plugins-icon-container fv-plugins-bootstrap5-row-invalid">
								<input type="text" class="form-control form-control-lg form-control-solid mb-3 mb-lg-0" placeholder="اسم المهمه" asp-for="Title">
								<span asp-validation-for="Title" class="fv-plugins-message-container invalid-feedback"></span>
							</div>
							<!--end::Col-->
						</div>
						<!--end::Row-->
					</div>
					<!--end::Col-->
				</div>
				<div class="row col-6 mb-6">
					<!--begin::Label-->
					<label class="mb-5 col-lg-4 col-form-label required fw-semibold fs-6">الموظفين</label>
					<!--end::Label-->
					<!--begin::Col-->
					<div class="col-lg-8">
						<!--begin::Row-->
						<div class="row">
							<!--begin::Col-->
							<div class="fv-row fv-plugins-icon-container fv-plugins-bootstrap5-row-invalid">
								<select aria-label="Select a Country" multiple data-control="select2" data-placeholder="الموظفين..." class="js-select2 form-select form-select-solid form-select-lg fw-semibold"
										asp-for="SelectedUsers" asp-items="Model.Users">
									<option value="">الموظفين...</option>
								</select>
								<span asp-validation-for="SelectedUsers" class="text-danger d-block"></span>
							</div>
							<!--end::Col-->
						</div>
						<!--end::Row-->
					</div>
					<!--end::Col-->
				</div>
			</div>
			<div class="row">
				<!--begin::Label-->
				<label class="mb-5 col-lg-4 col-form-label fw-semibold fs-6" asp-for="Notes"></label>
				<!--end::Label-->
				<!--begin::Col-->
				<div class="col-lg-8">
					<!--begin::Row-->
					<div class="row">
						<!--begin::Col-->
						<div class="col-lg-12 fv-row fv-plugins-icon-container fv-plugins-bootstrap5-row-invalid">
							<textarea class="form-control form-control-solid" type="text" placeholder="اكتب ملاحظاتك" asp-for="Notes"></textarea>
							<span asp-validation-for="Notes" class="fv-plugins-message-container invalid-feedback"></span>
							<!--end::Col-->
						</div>
					</div>
					<!--end::Row-->
				</div>
				<!--end::Col-->
			</div>
			@if (Model.Id > 0)
			{
				<div class="row">
					<!--begin::Label-->
					<label class="col-lg-4 col-form-label fw-semibold fs-6">ملف المهمه</label>
					<!--end::Label-->
					<!--begin::Col-->
					<div id="head" class="col-lg-8">
						@if (Model.ExistingFiles != null && Model.ExistingFiles.Any())
						{
							<div class="mb-3 col-lg-12">
								<!-- Display each existing image with a download link and name -->
								@foreach (var item in Model.ExistingFiles)
								{
									<div class="image-item" id="image-item-@i">
										<h3 class="fw-bold" title="@item.FileName" data-toggle="tooltip" data-placement="top">
											@((item.FileName?.Length > 60 ? item.FileName.Substring(0, 60) + "..." : item.FileName))
										</h3>
										<a href="@item.FileUrl" class="btn btn-primary mb-2" target="_blank">تحميل الملف @i</a>
										<button type="button" class="btn btn-sm btn-danger" onclick="deleteImage('@item.FileUrl', '@i')">حذف</button>
									</div>
									i++;
								}
							</div>
						}
					</div>
					<!--end::Col-->
				</div>
			}
			else
			{
				<!--begin::Row-->
				<div class="row">
					<!--begin::Label-->
					<label class="col-lg-4 col-form-label fw-semibold fs-6" asp-for="TaskFiles"></label>
					<!--end::Label-->
					<!--begin::Col-->
					<div id="head" class="mb-5 col-lg-8 fv-row fv-plugins-icon-container fv-plugins-bootstrap5-row-invalid">
					</div>
					<!--end::Col-->
				</div>
				<!--end::Row-->
			}
			<!-- Button to add more file inputs -->
			<button type="button" class="btn btn-info mb-2" onclick="addFileInput()">اضافه ملف</button>
			<!-- Hidden input to track deleted image URLs -->
			<input type="hidden" name="DeletedFileUrls" id="DeletedFileUrls" value="" />

		</form>

	</div>
	<div class="card-footer">
		<button type="submit" class="btn btn-primary" form="Form">
			<span class="indicator-label">
				حفظ
			</span>
			<span class="indicator-progress">
				رجاء الانتظار... <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
			</span>
		</button>
		<a class="btn btn-light text-primary ms-3" asp-action="Index">Cancel</a>
	</div>
</div>


@section Scripts
{
	<partial name="_ValidationScriptsPartial" />

	<script>
		$('.js-select2').select2({
						dir: "rtl", // الاتجاه من اليمين لليسار
						width: '100%',
						placeholder: "الموظفين..."
					});

		// Function to dynamically add new file input to the 'head' container
		function addFileInput() {
			// Get the 'head' container
			var container = document.getElementById('head');

			// Create a new div to hold the input and label
			var inputBlock = document.createElement('div');
			inputBlock.classList.add('mb-3');

			// Create label for new file input
			var label = document.createElement('label');
			label.classList.add('form-label');
			label.innerText = 'اختر ملف جديد:';

			// Create the new file input element
			var input = document.createElement('input');
			input.type = 'file';
			input.name = 'TaskFiles';
			input.classList.add('form-control');
			input.multiple = true;

			// Create a span for validation messages (if any)
			var validationSpan = document.createElement('span');
			validationSpan.classList.add('text-danger');

			// Append the label, input, and validation span to the input block
			inputBlock.appendChild(label);
			inputBlock.appendChild(input);
			inputBlock.appendChild(validationSpan);

			// Append the new input block to the 'head' container
			container.appendChild(inputBlock);
		}

		// Function to delete an image and remove it from the UI
		function deleteImage(imageUrl, imageIndex) {
			if (confirm('Are you sure you want to delete this image?')) {
				// Track deleted images in hidden field
				const deletedImagesInput = document.getElementById('DeletedFileUrls');
				let deletedFileUrls = deletedImagesInput.value ? deletedImagesInput.value.split(',') : [];
				deletedFileUrls.push(imageUrl);
				deletedImagesInput.value = deletedFileUrls.join(',');

				// Remove the image's UI element
				var imageItem = document.getElementById('image-item-' + imageIndex);
				if (imageItem) {
					imageItem.remove();
				}
			}
		}
	</script>
}